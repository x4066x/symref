# Symref アーキテクチャ設計書

## 1. システム概要

Symrefは、TypeScriptコードベースの静的解析を行うツールです。主にAIコードエージェントの支援を目的とし、以下の機能を提供します：

- シンボル参照解析
- 未使用コードの検出
- 依存関係の分析
- 循環参照の検出
- 呼び出しグラフ分析

## 2. システム構成

### 2.1 コアコンポーネント

```
src/
├── analyzer/     # 静的解析エンジン
├── types/        # 型定義
├── cli/          # コマンドラインインターフェース
└── utils/        # ユーティリティ関数
```

### 2.2 主要なモジュール

1. **Analyzer**
   - TypeScriptのAST解析
   - シンボル参照の追跡
   - 依存関係の構築
   - 呼び出しグラフの生成

2. **CLI**
   - コマンドライン引数の処理
   - 設定ファイルの読み込み
   - 結果の出力フォーマット

3. **Types**
   - 解析結果の型定義
   - 設定オプションの型定義
   - 共通インターフェース

## 3. データフロー

1. **入力処理**
   - コマンドライン引数の解析
   - 設定ファイルの読み込み
   - 対象ファイルの特定

2. **解析処理**
   - TypeScriptファイルのAST解析
   - シンボル定義の抽出
   - 参照関係の構築
   - 呼び出しグラフの生成

3. **結果出力**
   - 解析結果のフォーマット
   - 警告・エラーメッセージの生成
   - 結果の表示

## 4. 主要なインターフェース

### 4.1 シンボル解析

```typescript
interface SymbolAnalyzer {
  analyzeSymbol(symbolName: string): SymbolAnalysis;
  findReferences(symbol: Symbol): Reference[];
  buildDependencyGraph(): DependencyGraph;
}
```

### 4.2 呼び出しグラフ

```typescript
interface CallGraph {
  addNode(symbol: Symbol): void;
  addEdge(from: Symbol, to: Symbol): void;
  findPath(start: Symbol, end: Symbol): Path[];
}
```

## 5. 設定オプション

### 5.1 基本設定

- `dir`: 解析対象ディレクトリ
- `project`: TypeScript設定ファイル
- `include`: 対象ファイルパターン
- `exclude`: 除外ファイルパターン

### 5.2 解析オプション

- `maxDepth`: 呼び出しグラフの最大深さ
- `ignorePatterns`: 無視するパターン
- `strictMode`: 厳格な解析モード

## 6. エラーハンドリング

### 6.1 主要なエラーケース

1. **ファイル関連**
   - ファイルが見つからない
   - ファイルの読み込みエラー
   - 不正なファイル形式

2. **解析エラー**
   - 構文エラー
   - 型エラー
   - 循環参照

3. **設定エラー**
   - 不正な設定値
   - 必須設定の欠落
   - 設定ファイルの読み込みエラー

## 7. 拡張性

### 7.1 プラグインシステム

- カスタム解析ルール
- 出力フォーマットの拡張
- 新しいコマンドの追加

### 7.2 API

- 外部ツールからの利用
- CI/CDパイプラインへの統合
- カスタムレポートの生成

## 8. パフォーマンス考慮事項

### 8.1 最適化戦略

- キャッシュの活用
- 並列処理
- インクリメンタル解析

### 8.2 メモリ管理

- 大規模プロジェクトの処理
- メモリリークの防止
- リソースの解放 